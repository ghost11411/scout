#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# ---------------- CONFIG ----------------
INSTALL_DIR="${HOME}/scout"
TOOLS_DIR="${INSTALL_DIR}/tools"
BIN_DIR="${TOOLS_DIR}/bin"
WORDLISTS_DIR="${INSTALL_DIR}/wordlists"
GF_DIR="$WORDLISTS_DIR/GF-Patterns"
LOG_FILE="/tmp/scout_installer.log"
mkdir -p "$BIN_DIR" "$GF_DIR" "$WORDLISTS_DIR"
: > "$LOG_FILE"

# ---------------- COLORS ----------------
BLUE="\e[94m"; GREEN="\e[92m"; YELLOW="\e[93m"; RED="\e[91m"; RESET="\e[0m"; BOLD="\e[1m"; CYAN="\033[0;36m"; HIGH_GREEN="\e[38;5;82m";
VER=v0.1

OK()      { printf "${GREEN}[✔] %s${RESET}\n" "$1"; }
INFO()    { printf "${BLUE}[*] %s${RESET}\n" "$1"; }
WARN()    { printf "${YELLOW}[!] %s${RESET}\n" "$1"; }
ERR()     { printf "${RED}[✘] %s${RESET}\n" "$1"; echo "$(date --iso-8601=seconds) - $1" >> "$LOG_FILE"; }

# ---------------- ASCII BANNER ----------------
BANNER(){
  ASCII_SCOUT=$(cat <<'EOF'
    /$$$$$$   /$$$$$$   /$$$$$$  /$$   /$$ /$$$$$$$$
   /$$__  $$ /$$__  $$ /$$__  $$| $$  | $$|__  $$__/
  | $$  \__/| $$  \__/| $$  \ $$| $$  | $$   | $$   
  |  $$$$$$ | $$      | $$  | $$| $$  | $$   | $$   
   \____  $$| $$      | $$  | $$| $$  | $$   | $$   
   /$$  \ $$| $$    $$| $$  | $$| $$  | $$   | $$   
  |  $$$$$$/|  $$$$$$/|  $$$$$$/|  $$$$$$/   | $$   
   \______/  \______/  \______/  \______/    |__/   
EOF
  )
  local tag="${VER:-v?}"
  TAGLINE="Recon Made Easy                  Made By Ghost ${tag}"

  echo -e "${BOLD}${GREEN}=====================================================${RESET}"
  echo -e "${HIGH_GREEN}${BOLD}${ASCII_SCOUT}${RESET}"
  echo -e "${CYAN}${BOLD}${TAGLINE}${RESET}"
  echo -e "${BOLD}${GREEN}=====================================================${RESET}"
}

# ---------------- HELPERS ----------------
RUN_CMD() {
    local DESC="$1"
    shift
    if "$@" >>"$LOG_FILE" 2>&1; then
        OK "$DESC"
        return 0
    else
        ERR "$DESC failed. Check $LOG_FILE"
        return 1
    fi
}

CHECK_COMMAND() { command -v "$1" >/dev/null 2>&1; }

# ---------------- TOOLSETS ----------------
GO_TOOLS=(
    "mapcidr|github.com/projectdiscovery/mapcidr/cmd/mapcidr@latest"
    "amass|github.com/owasp-amass/amass/v4/...@master"
    "assetfinder|github.com/tomnomnom/assetfinder@latest"
    "subfinder|github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest"
    "waybackurls|github.com/tomnomnom/waybackurls@latest"
    "gau|github.com/lc/gau/v2/cmd/gau@latest"
    "dnsx|github.com/projectdiscovery/dnsx/cmd/dnsx@latest"
    "gf|github.com/tomnomnom/gf@latest"
    "unfurl|github.com/tomnomnom/unfurl@latest"
    "httprobe|github.com/tomnomnom/httprobe@latest"
    "httpx|github.com/projectdiscovery/httpx/cmd/httpx@latest"
    "ffuf|github.com/ffuf/ffuf/v2@latest"
    "nuclei|github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest"
    "naabu|github.com/projectdiscovery/naabu/v2/cmd/naabu@latest"
    "notify|github.com/projectdiscovery/notify/cmd/notify@latest"
)

APT_PACKAGES=(
    coreutils git whois jq unzip python3 python3-pip python3-requests python3-dnspython pipx parallel gcc curl wget zip cewl python3-shodan make ca-certificates libpcap-dev golang-go
)

PIPX_TOOLS=("arjun")

REPOS=(
    "1ndianl33t/GF-Patterns|$GF_DIR|https://github.com/1ndianl33t/GF-Patterns.git"
    "aboul3la/Sublist3r|$TOOLS_DIR/Sublist3r|https://github.com/aboul3la/Sublist3r.git"
)

# ---------------- CLEANUP ----------------
CLEANUP_ITEMS=()
CLEANUP() {
    for ITEM in "${CLEANUP_ITEMS[@]:-}"; do
        [ -e "$ITEM" ] && rm -rf "$ITEM" || true
    done
}
trap CLEANUP EXIT

# ---------------- ACTIONS ----------------
ENSURE_BASIC_COMMANDS() {
    local OKAY=0
    for CMD in git curl jq tar unzip go bash; do
        if ! CHECK_COMMAND "$CMD"; then
            ERR "Required command '$CMD' not found"
            OKAY=1
        fi
    done
    [ "$OKAY" -eq 0 ]
}

INSTALL_APT_PACKAGES() {
    INFO "Updating apt cache..."
    sudo apt update -y >>"$LOG_FILE" 2>&1 || WARN "apt update failed"
    INFO "Installing apt packages..."
    sudo apt install -y "${APT_PACKAGES[@]}" >>"$LOG_FILE" 2>&1 || WARN "apt install failed"
    OK "apt packages installed"
}

INSTALL_PIPX_TOOLS() {
    if ! CHECK_COMMAND pipx; then
        INFO "Installing pipx"
        python3 -m pip install --user pipx >>"$LOG_FILE" 2>&1 || true
        python3 -m pipx ensurepath >>"$LOG_FILE" 2>&1 || true
    fi
    # export PATH="$HOME/.local/bin:$PATH"
    for T in "${PIPX_TOOLS[@]}"; do
        if ! pipx list | grep -qE "^\s*$T" 2>/dev/null; then
            python3 -m pipx install "$T" >>"$LOG_FILE" 2>&1 || true
            OK "Installed $T via pipx"
        else
            INFO "$T already installed via pipx"
        fi
    done
}

INSTALL_GO_TOOLS_ONE_BY_ONE() {
    if ! CHECK_COMMAND go; then
        WARN "Go not found; skipping Go tools"
        return
    fi
    echo "Sleeping 2s before env set"; sleep 2
    export GOBIN="$BIN_DIR"
    export PATH="$GOBIN:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"
    echo "Sleeping 2s after env set"; sleep 2

    INFO "Installing Go tools..."
    for PAIR in "${GO_TOOLS[@]}"; do
        NAME="${PAIR%%|*}"
        PKG="${PAIR#*|}"
        if env GOBIN="$GOBIN" go install "$PKG" >>"$LOG_FILE" 2>&1; then
            OK "$NAME"
        else
            ERR "$NAME failed"
        fi
    done
}

INSTALL_MASSCAN() {
    if [ -x "$BIN_DIR/masscan" ]; then
        INFO "masscan already present"
        return
    fi
    local DIR
    DIR=$(mktemp -d)
    CLEANUP_ITEMS+=("$DIR")
    git clone --depth 1 https://github.com/robertdavidgraham/masscan.git "$DIR" >>"$LOG_FILE" 2>&1 || return 1
    make -C "$DIR" -j"$(nproc)" >>"$LOG_FILE" 2>&1 || return 1
    if [ -f "$DIR/bin/masscan" ]; then
        mv "$DIR/bin/masscan" "$BIN_DIR/"
        chmod +x "$BIN_DIR/masscan"
        OK "masscan"
    else
        ERR "masscan build failed"
    fi
}

INSTALL_NMAP() {
    local ARCH
    ARCH=$(uname -m || true)
    if [ "$ARCH" = "x86_64" ]; then
        local URL="https://github.com/andrew-d/static-binaries/raw/master/binaries/linux/x86_64/nmap"
        INFO "Installing nmap"
        curl -fsSL "$URL" -o "$BIN_DIR/nmap" >>"$LOG_FILE" 2>&1 && chmod +x "$BIN_DIR/nmap" && OK "nmap" || WARN "Failed to fetch nmap"
    else
        INFO "Skipping nmap for arch $ARCH"
    fi
}

INSTALL_FINDOMAIN() {
    if [ -x "$BIN_DIR/findomain" ]; then
        INFO "findomain already installed"
        return
    fi
    INFO "Installing findomain"
    local VER TMP
    VER=$(curl -fsSL https://github.com/Findomain/Findomain/releases/latest 2>>"$LOG_FILE" | grep -Eo 'tag/[0-9A-Za-z._-]+' | head -n1 | cut -d'/' -f2 || true)
    [ -z "$VER" ] && { WARN "Could not determine findomain latest version"; return; }
    TMP=$(mktemp -d)
    CLEANUP_ITEMS+=("$TMP")
    curl -fsSL -L "https://github.com/Findomain/Findomain/releases/download/$VER/findomain-linux.zip" -o "$TMP/findomain.zip" >>"$LOG_FILE" 2>&1
    unzip -o "$TMP/findomain.zip" -d "$TMP" >>"$LOG_FILE" 2>&1 || true
    if [ -f "$TMP/findomain" ]; then
        mv "$TMP/findomain" "$BIN_DIR/findomain"
        chmod +x "$BIN_DIR/findomain"
        OK "findomain"
    else
        WARN "findomain binary not found"
    fi
}

CLONE_OR_UPDATE_REPOS() {
    for ENTRY in "${REPOS[@]}"; do
        IFS='|' read -r NAME PATH GITURL <<< "$ENTRY"
        if [ -d "$INSTALL_DIR/.git" ]; then
            INFO "Updating $NAME"
            git -C "$INSTALL_DIR" pull --ff-only >>"$LOG_FILE" 2>&1 || true
        else
            INFO "Cloning $NAME"
            git clone --depth 1 "$GITURL" "$INSTALL_DIR" >>"$LOG_FILE" 2>&1 || true
        fi
        OK "$NAME setup complete"
    done
}

UPDATE_NUCLEI_TEMPLATES() {
    if CHECK_COMMAND nuclei; then
        "$BIN_DIR/nuclei" -ut >>"$LOG_FILE" 2>&1 && OK "Nuclei templates updated" || WARN "Nuclei template update failed"
    else
        WARN "nuclei not found; skip templates update"
    fi
}

# ---------------- MAIN INSTALL ----------------
BANNER
INFO "Starting full install"
INSTALL_APT_PACKAGES || true
ENSURE_BASIC_COMMANDS || true
INSTALL_PIPX_TOOLS || true
INSTALL_GO_TOOLS_ONE_BY_ONE || true
INSTALL_MASSCAN || true
INSTALL_NMAP || true
INSTALL_FINDOMAIN || true
CLONE_OR_UPDATE_REPOS || true
UPDATE_NUCLEI_TEMPLATES || true

chmod 755 "$BIN_DIR"/* 2>/dev/null || true
[ -f "$INSTALL_DIR/scout" ] && chmod +x "$INSTALL_DIR/scout" || true
if [ -w /usr/local/bin ]; then
    ln -sf "$INSTALL_DIR/scout" /usr/local/bin/scout && OK "Symlink created"
elif sudo -n true 2>/dev/null; then
    sudo ln -sf "$INSTALL_DIR/scout" /usr/local/bin/scout && OK "Symlink created (sudo)"
else
    WARN "Could not symlink; run manually: sudo ln -sf $INSTALL_DIR/scout /usr/local/bin/scout"
fi

OK "Install finished"
exit 0
# ---------------- END ---------------- 

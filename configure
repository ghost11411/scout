#!/usr/bin/env bash
set -euo pipefail
IFS=$' \t\n'

# ---------------- COLORS ----------------
BLUE="\e[94m"; GREEN="\e[92m"; YELLOW="\e[93m"; RED="\e[91m"; RESET="\e[0m"; BOLD="\e[1m"; CYAN="\033[0;36m"; HIGH_GREEN="\e[38;5;82m"

# ---------------- VARIABLES ----------------
VER="v0.1"
REPO_URL="https://github.com/ghost11411/scout"
INSTALL_DIR="${HOME}/scout"
FORCE=false
UPDATE=false
UNINSTALL=false

# ---------------- BANNER ----------------
BANNER() {
  local ASCII_SCOUT=$(cat <<'EOF'
    /$$$$$$   /$$$$$$   /$$$$$$  /$$   /$$ /$$$$$$$$
   /$$__  $$ /$$__  $$ /$$__  $$| $$  | $$|__  $$__/
  | $$  \__/| $$  \__/| $$  | $$| $$  | $$   | $$   
  |  $$$$$$ | $$      | $$  | $$| $$  | $$   | $$   
   \____  $$| $$      | $$  | $$| $$  | $$   | $$   
   /$$  \ $$| $$    $$| $$  | $$| $$  | $$   | $$   
  |  $$$$$$/|  $$$$$$/|  $$$$$$/|  $$$$$$/   | $$   
   \______/  \______/  \______/  \______/    |__/   
EOF
  )
  local TAGLINE="Recon Made Easy                  Made By Ghost ${VER}"
  echo -e "${BOLD}${GREEN}=====================================================${RESET}"
  while IFS= read -r LINE; do
    for ((i=0;i<${#LINE};i++)); do
      printf "${HIGH_GREEN}${BOLD}%c${RESET}" "${LINE:i:1}"
      sleep 0.0005
    done
    printf "\n"
  done <<< "$ASCII_SCOUT"
  for ((i=0;i<${#TAGLINE};i++)); do
    printf "${CYAN}${BOLD}%c${RESET}" "${TAGLINE:i:1}"
    sleep 0.001
  done
  printf "\n\n"
  echo -e "${BOLD}${GREEN}=====================================================${RESET}"
}

# ---------------- LOGGING ----------------
OK()      { printf "${GREEN}[✓] %s${RESET}\n" "$1"; }
INFO()    { printf "${BLUE}[*] %s${RESET}\n" "$1"; }
WARN()    { printf "${YELLOW}[!] %s${RESET}\n" "$1"; }
ERR()     { printf "${RED}[X] %s${RESET}\n" "$1" > /dev/null 2>&1; }

# ---------------- PARSE FLAGS ----------------
for ARG in "$@"; do
    case "$ARG" in
        --force) FORCE=true ;;
        --update) UPDATE=true ;;
        --uninstall) UNINSTALL=true ;;
        --help|-h)
            cat <<EOF
Usage: configure [--force] [--update] [--uninstall]
  --force     Remove and reinstall
  --update    Pull latest changes
  --uninstall Remove everything
EOF
            exit 0 ;;
        *) ERR "Unknown option: $ARG"; exit 1 ;;
    esac
done

BANNER

# ---------------- ROOT CHECK ----------------
(( EUID != 0 )) && { ERR "Run as Root with sudo"; exit 1; }

# ---------------- UNINSTALL ----------------
if $UNINSTALL; then
    INFO "Uninstalling..."
    [[ -d "$INSTALL_DIR" ]] && rm -rf "$INSTALL_DIR" && OK "Removed $INSTALL_DIR"
    [[ -L /usr/local/bin/scout ]] && rm -f /usr/local/bin/scout && OK "Removed symlink"
    OK "Uninstalled"
    exit 0
fi

# ---------------- FORCE ----------------
if $FORCE; then
    WARN "--force: Removing Old Install"
    [[ -d "$INSTALL_DIR" ]] && rm -rf "$INSTALL_DIR" && OK "Old Install Removed"
    INFO "Cloning Fresh Repository..."
    if git clone "$REPO_URL" "$INSTALL_DIR" > /dev/null 2>&1; then
        OK "Repository Cloned"
        INFO "Running Installer..."
        chmod -R +x "$INSTALL_DIR/cmd/"
        $INSTALL_DIR/cmd/installer 
    else
        ERR "Clone Failed"
        exit 1
    fi
# ---------------- UPDATE ----------------
elif $UPDATE; then
    if [[ -d "$INSTALL_DIR/.git" ]]; then
        INFO "Updating Existing Install..."
        (cd "$INSTALL_DIR" && git reset --hard && git pull --rebase --autostash) > /dev/null 2>&1 && OK "Updated" || WARN "Update failed"
        INFO "Running Installer..."
        chmod -R +x "$INSTALL_DIR/cmd/"
        $INSTALL_DIR/cmd/installer
    else
        WARN "$INSTALL_DIR is not a git repo – skipping update use --force to reinstall"
    fi
# ---------------- DEFAULT (no flags) ----------------
else
    [[ -d "$INSTALL_DIR" ]] && { ERR "$INSTALL_DIR exists. Use --force or --update."; exit 1; }
    INFO "Fresh Install – Cloning Repository..."
    if git clone "$REPO_URL" "$INSTALL_DIR" > /dev/null 2>&1; then
        OK "Repository Cloned"
        INFO "Running Installer..."
        chmod -R +x "$INSTALL_DIR/cmd/"
        $INSTALL_DIR/cmd/installer 
    else
        ERR "Clone Failed"
        exit 1
    fi
fi
#!/usr/bin/env bash
set -euo pipefail
IFS=$' \t\n'

# ---------------- COLORS ----------------
BLUE="\e[94m"; GREEN="\e[92m"; YELLOW="\e[93m"; RED="\e[91m"; RESET="\e[0m"; BOLD="\e[1m"; CYAN="\033[0;36m"; HIGH_GREEN="\e[38;5;82m"

# ---------------- VARIABLES ----------------
VER="v0.1"
REPO_URL="https://github.com/ghost11411/scout"
INSTALL_DIR="${HOME}/scout"
FORCE=0
UPDATE=0
UNINSTALL=0

# ---------------- LOGGING ----------------
OK()   { printf "${GREEN}[✓] %s${RESET}\n" "$1"; }
INFO() { printf "${BLUE}[*] %s${RESET}\n" "$1"; }
WARN() { printf "${YELLOW}[!] %s${RESET}\n" "$1"; }
ERR()  { printf "${RED}[X] %s${RESET}\n" "$1" >&2; }

# ---------------- BANNER ----------------
BANNER(){
  ASCII_SCOUT=$(cat <<'EOF'
    /$$$$$$   /$$$$$$   /$$$$$$  /$$   /$$ /$$$$$$$$
   /$$__  $$ /$$__  $$ /$$__  $$| $$  | $$|__  $$__/
  | $$  \__/| $$  \__/| $$  | $$| $$  | $$   | $$
  |  $$$$$$ | $$      | $$  | $$| $$  | $$   | $$
   \____  $$| $$      | $$  | $$| $$  | $$   | $$
   /$$  \ $$| $$    $$| $$  | $$| $$  | $$   | $$
  |  $$$$$$/|  $$$$$$/|  $$$$$$/|  $$$$$$/   | $$
   \______/  \______/  \______/  \______/    |__/
EOF
  )
  TAGLINE="Recon Made Easy                  Made By Ghost ${VER}"
  echo -e "${BOLD}${GREEN}=====================================================${RESET}"

  # Animate ASCII letters line by line
  while IFS= read -r LINE; do
    for ((i=0;i<${#LINE};i++)); do
      printf "${HIGH_GREEN}${BOLD}%c${RESET}" "${LINE:i:1}"
      sleep 0.0005
    done
    printf "\n"
  done <<< "$ASCII_SCOUT"

  # Animate tagline
  for ((i=0;i<${#TAGLINE};i++)); do
    printf "${CYAN}${BOLD}%c${RESET}" "${TAGLINE:i:1}"
    sleep 0.001
  done
  printf "\n"
  echo -e "${BOLD}${GREEN}=====================================================${RESET}"
}

# ---------------- CLEAN EXIT ----------------
trap 'ERR "Installation interrupted"; exit 1' INT TERM

# ---------------- REQUIRE ROOT ----------------
REQUIRE_ROOT() {
  if (( EUID != 0 )); then
    echo -e "${RED}[X] Root privileges required.${RESET}"
    echo -e "${YELLOW}[*] Re-running with sudo...${RESET}\n"
    exec sudo -E bash "$0" "$@"  # Preserve env and args
  fi
}

# ---------------- DEP CHECK ----------------
CHECK_DEPS() {
  for cmd in git curl; do
    if ! command -v "$cmd" >/dev/null 2>&1; then
      ERR "Missing dependency: $cmd"
      exit 1
    fi
  done
}

# ---------------- HELP ----------------
USAGE() {
cat <<EOF
Usage: configure [--force] [--update] [--uninstall] [--version]
  --force       Remove and reinstall
  --update      Pull latest changes
  --uninstall   Remove everything
  --version     Show installer version
  --help, -h    Show this help
EOF
}

# ---------------- PARSE FLAGS ----------------
for ARG in "$@"; do
    case "$ARG" in
        --force|-f) FORCE=1 ;;
        --update|-up) UPDATE=1 ;;
        --uninstall|-un) UNINSTALL=1 ;;
        --version|-v) echo "Scout Installer ${VER}"; exit 0 ;;
        --help|-h) USAGE; exit 0 ;;
        *) ERR "Unknown option: $ARG"; USAGE; exit 1 ;;
    esac
done

# ---------------- MAIN ----------------a
BANNER
REQUIRE_ROOT "$@"
CHECK_DEPS

# ---------------- UNINSTALL ----------------
if (( UNINSTALL )); then
    INFO "Uninstalling..."
    [[ -d "$INSTALL_DIR" ]] && rm -rf "$INSTALL_DIR" && OK "Removed $INSTALL_DIR"
    pipx uninstall subdominator > /dev/null 2>&1 || true
    [[ -L /usr/local/bin/scout ]] && rm -f /usr/local/bin/scout && OK "Removed symlink"
    OK "Uninstalled successfully."
    exit 0
fi

# ---------------- FORCE INSTALL ----------------
if (( FORCE )); then
    WARN "--force: Removing old installation..."
    [[ -d "$INSTALL_DIR" ]] && rm -rf "$INSTALL_DIR" && OK "Old install removed"
    INFO "Cloning fresh repository..."
    git clone --depth 1 "$REPO_URL" "$INSTALL_DIR" --progress > /dev/null 2>&1
    OK "Repository cloned"
    INFO "Running installer..."
    chmod -R +x "$INSTALL_DIR/cmd/"
    bash "$INSTALL_DIR/cmd/installer"
# ---------------- UPDATE ----------------
elif (( UPDATE )); then
    if [[ -d "$INSTALL_DIR/.git" ]]; then
        INFO "Updating existing install..."
        (cd "$INSTALL_DIR" && git reset --hard > /dev/null 2>&1 && git pull --rebase --autostash > /dev/null 2>&1)
        OK "Repository updated"
        INFO "Running installer..."
        chmod -R +x "$INSTALL_DIR/cmd/"
        bash "$INSTALL_DIR/cmd/installer"
        OK "Update complete."
    else
        WARN "$INSTALL_DIR is not a git repo – use --force to reinstall."
    fi
# ---------------- DEFAULT INSTALL ----------------
else
    [[ -d "$INSTALL_DIR" ]] && { ERR "$INSTALL_DIR already exists. Use --force or --update."; exit 1; }
    INFO "Fresh install – cloning repository..."
    git clone --depth 1 "$REPO_URL" "$INSTALL_DIR" --progress > /dev/null 2>&1
    OK "Repository cloned"
    INFO "Running installer..."
    chmod -R +x "$INSTALL_DIR/cmd/"
    bash "$INSTALL_DIR/cmd/installer"
fi
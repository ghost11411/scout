#!/usr/bin/env bash
set -euo pipefail
IFS=$' \t\n'

# ---------------- SUBDOMAIN COLLECTION ----------------
COLLECT_SUBDOMAINS(){
  while read -r domain; do
    domain=$(echo "$domain" | tr -d '[:space:]')
    [ -z "$domain" ] && continue
    INFO "Collecting subdomains for $domain"    
    INFO "subfinder" && "$BIN_DIR/subfinder" -d "$domain" -all -silent -o "$RAW_DIR/subfinder.out"
    INFO "assetfinder" && echo "$domain" | "$BIN_DIR/assetfinder" -subs-only | sort -u >> "$RAW_DIR/assetfinder.out"
    INFO "findomain" && "$BIN_DIR/findomain" -t "$domain" --quiet -u "$RAW_DIR/findomain.out"
    INFO "gau" && echo "$domain" | "$BIN_DIR/gau" --subs | "$BIN_DIR/unfurl" -u domains | sort -u >> "$RAW_DIR/gau.out"
    INFO "waybackurls" && "$BIN_DIR/waybackurls" "$domain" | "$BIN_DIR/unfurl" -u domains | sort -u >> "$RAW_DIR/wayback.out"
    INFO "subdog" && echo "$domain" | "$BIN_DIR"/subdog --silent | sort -u >> "$RAW_DIR/subdog.out"
    INFO "xsubfind3r" && "$BIN_DIR/xsubfind3r" -d "$domain" -o "$RAW_DIR/xsubfind3r.out"
    INFO "cero" && "$BIN_DIR/cero" -d "$domain" | sort -u >> "$RAW_DIR/cero.out"
    INFO "crt-sh" && curl -sk "https://crt.sh/?q=$domain&output=json" | tr ',' '\n' | awk -F'"' '/name_value/ {gsub(/\*\./, "", $4); gsub(/\\n/,"\n",$4);print $4}' | sort -u >> "$RAW_DIR/crt.out"
    # INFO "amass" && "$BIN_DIR/amass" enum -d "$domain" -o "$RAW_DIR/amass.out"
  done < "$INPUT_WILDCARD_ALL_FILE"

  # after all tools finished for all domains, combine into single file
  ALL_SUBS_FILE="$RAW_DIR/all_subdomains.out"
  > "$ALL_SUBS_FILE"
  for d in "$RAW_DIR"/*; do
    [[ -d "$d" ]] || continue
    cat "$d"/*.out 2>/dev/null || true
  done | $(command -v unfurl || echo "$BIN_DIR/unfurl") -u domains 2>/dev/null | sort -u > "$ALL_SUBS_FILE" || true
  OK "Collected all subdomains -> $ALL_SUBS_FILE"
}
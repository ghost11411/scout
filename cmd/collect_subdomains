#!/usr/bin/env bash
set -euo pipefail
IFS=$' \t\n'

# ---------------- SUBDOMAIN COLLECTION ----------------
COLLECT_SUBDOMAINS(){
  while read -r domain; do
    domain=$(echo "$domain" | tr -d '[:space:]')
    [ -z "$domain" ] && continue

    # Subfinder
    START_SPINNER "Running subfinder on $domain"
    # INFO "subfinder running on $domain" &&
    "$BIN_DIR/subfinder" -d "$domain" -all -silent >> "$RAW_DIR/subfinder.out" 2>/dev/null || true
    STOP_SPINNER
    COUNT=$(wc -l < "$RAW_DIR/subfinder.out" || echo 0)
    OK "subfinder found: $COUNT subdomains"

    # Assetfinder
    START_SPINNER "Running assetfinder on $domain"
    # INFO "assetfinder running on $domain" && 
    echo "$domain" | "$BIN_DIR/assetfinder" -subs-only | sort -u >> "$RAW_DIR/assetfinder.out" 2>/dev/null || true
    STOP_SPINNER
    COUNT=$(wc -l < "$RAW_DIR/assetfinder.out" || echo 0)
    OK "assetfinder found: $COUNT subdomains"
    
    # Findomain
    START_SPINNER "Running findomain on $domain"
    # INFO "findomain running on $domain" && 
    "$BIN_DIR/findomain" -t "$domain" --quiet >> "$RAW_DIR/findomain.out" 2>/dev/null || true
    STOP_SPINNER
    COUNT=$(wc -l < "$RAW_DIR/findomain.out" || echo 0)
    OK "findomain found: $COUNT subdomains"
    
    # Gau + unfurl
    START_SPINNER "Running gau on $domain"
    # INFO "gau running on $domain" && 
    echo "$domain" | "$BIN_DIR/gau" --subs | "$BIN_DIR/unfurl" -u domains | sort -u >> "$RAW_DIR/gau.out" 2>/dev/null || true
    STOP_SPINNER
    COUNT=$(wc -l < "$RAW_DIR/gau.out" || echo 0)
    OK "gau found: $COUNT subdomains"
    
    # Waybackurls + unfurl
    START_SPINNER "Running waybackurls on $domain"
    # INFO "waybackurls running on $domain" && 
    "$BIN_DIR/waybackurls" "$domain" | "$BIN_DIR/unfurl" -u domains | sort -u >> "$RAW_DIR/wayback.out" 2>/dev/null || true
    STOP_SPINNER
    COUNT=$(wc -l < "$RAW_DIR/gau.out" || echo 0)
    OK "gau found: $COUNT subdomains"
    
    # Subdog
    START_SPINNER "Running subdog on $domain"
    # INFO "subdog running on $domain" && 
    echo "$domain" | "$BIN_DIR"/subdog --silent | sort -u >> "$RAW_DIR/subdog.out"
    STOP_SPINNER
    COUNT=$(wc -l < "$RAW_DIR/subdog.out" || echo 0)
    OK "subdog found: $COUNT subdomains"
    
    # Xsubfind3r
    START_SPINNER "Running xsubfind3r on $domain"
    # INFO "xsubfind3r running on $domain" && 
    "$BIN_DIR/xsubfind3r" -d "$domain" -s >> "$RAW_DIR/xsubfind3r.out" 2>/dev/null || true
    STOP_SPINNER
    COUNT=$(wc -l < "$RAW_DIR/xsubfind3r.out" || echo 0)
    OK "xsubfind3r found: $COUNT subdomains"
    
    # Cero
    START_SPINNER "Running cero on $domain"
    # INFO "cero running on $domain" && 
    "$BIN_DIR/cero" -d "$domain" | sort -u >> "$RAW_DIR/cero.out" 2>/dev/null || true
    STOP_SPINNER
    COUNT=$(wc -l < "$RAW_DIR/cero.out" || echo 0)
    OK "cero found: $COUNT subdomains"
    
    # Crt.sh
    START_SPINNER "Running crt.sh on $domain"
    # INFO "crt-sh running on $domain" && 
    curl -sk "https://crt.sh/?q=$domain&output=json" | tr ',' '\n' | awk -F'"' '/name_value/ {gsub(/\*\./, "", $4); gsub(/\\n/,"\n",$4);print $4}' | sort -u >> "$RAW_DIR/crt.out" 2>/dev/null || true
    STOP_SPINNER
    COUNT=$(wc -l < "$RAW_DIR/crt.out" || echo 0)
    OK "crt-sh found: $COUNT subdomains"
    
    # Amass
    # START_SPINNER "Running Amass on $domain"
    # INFO "amass" && "$BIN_DIR/amass" enum -d "$domain" -o "$RAW_DIR/amass.out"
    # STOP_SPINNER
    # COUNT=$(wc -l < "$RAW_DIR/amass.out" || echo 0)
    # OK "amass found: $COUNT subdomains"
    OK "Completed subdomain collection for $domain"
  done < "$INPUT_WILDCARD_ALL_FILE"

  # after all tools finished for all domains, combine into single file
  START_SPINNER "Combining all subdomain results"
  ALL_SUBS_FILE="$COLLECTED_DIR/all_subdomains.out"
  : > "$ALL_SUBS_FILE"
  for f in "$RAW_DIR"/*; do
    cat "$f" >> "$ALL_SUBS_FILE" 2>/dev/null || true
  done
  sort -u "$ALL_SUBS_FILE" -o "$ALL_SUBS_FILE"
  STOP_SPINNER
  OK "Collected all subdomains -> $ALL_SUBS_FILE"
}
#!/usr/bin/env bash
set -euo pipefail
IFS=$' \t\n'

# ---------------- JS FILE COLLECTION ----------------
COLLECT_JS(){
  while read -r DOMAIN; do
    DOMAIN=$(echo "$DOMAIN" | tr -d '[:space:]')
    [ -z "$DOMAIN" ] && continue
    INFO "Collecting JS files for $DOMAIN"
    START_SPINNER "Running GAU"
    "$BIN_DIR/gau" "$DOMAIN" | grep -iE '\.js$' | sort -u > "$RAW_DIR/gau_js.out"
    STOP_SPINNER
    START_SPINNER "Running Waybackurls"
    "$BIN_DIR/waybackurls" "$DOMAIN" | grep -iE '\.js$' | sort -u > "$RAW_DIR/$DOMAIN/wayback_js.out"
    STOP_SPINNER
    START_SPINNER "Running katana"
    echo "$DOMAIN" | "$BIN_DIR/katana" -js-only -silent | grep -iE '\.js$' | sort -u > "$RAW_DIR/$DOMAIN/katana_js.out"
    STOP_SPINNER
    START_SPINNER "Running Hakrawler"
    echo "$DOMAIN" | "$BIN_DIR/hakrawler" -silent -js | grep -iE '\.js$' | sort -u > "$RAW_DIR/$DOMAIN/hakrawler_js.out"
    STOP_SPINNER
  done < "$WILDCARDS"
  # after all tools finished for all domains, combine into single file
  ALL_JS_FILE="$RAW_DIR/all_js_files.out"
  : > "$ALL_JS_FILE"
  for d in "$RAW_DIR"/*; do
    [[ -d "$d" ]] || continue
    cat "$d"/*_js.out 2>/dev/null || true
  done | sort -u > "$ALL_JS_FILE" || true
  OK "Collected all JS files -> $ALL_JS_FILE"
}
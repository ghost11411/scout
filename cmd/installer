#!/usr/bin/env bash
set -euo pipefail
IFS=$' \t\n'

# ---------------- START TIMER ----------------
START_TIME=$(date +%s)
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$PATH"

# ---------------- COLORS ----------------
BLUE="\e[94m"; GREEN="\e[92m"; YELLOW="\e[93m"; RED="\e[91m"; RESET="\e[0m"
BOLD="\e[1m"; CYAN="\033[0;36m"; HIGH_GREEN="\e[38;5;82m"

# ---------------- VARIABLES ----------------
VER="v0.1"
REPO_URL="https://github.com/ghost11411/scout"
INSTALL_DIR="${HOME}/scout"
TOOLS_DIR="${INSTALL_DIR}/tools"
BIN_DIR="${TOOLS_DIR}/bin"
WORDLISTS_DIR="${TOOLS_DIR}/wordlists"
GF_DIR="$WORDLISTS_DIR/GF-Patterns"
SUBLISTER_DIR="$BIN_DIR/sublist3r"

APT_PACKAGES=(
  git whois jq unzip python3 python3-pip python3-requests python3-dnspython gcc 
  curl wget zip python3-shodan make ca-certificates libpcap-dev golang-go pipx
)

GO_TOOLS=(
  "assetfinder|github.com/tomnomnom/assetfinder@latest"
  "subfinder|github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest"
  "waybackurls|github.com/tomnomnom/waybackurls@latest"
  "gau|github.com/lc/gau/v2/cmd/gau@latest"
  "subdog|github.com/rix4uni/subdog@latest"
  "xsubfind3r|github.com/hueristiq/xsubfind3r/cmd/xsubfind3r@latest"
  "cero|github.com/glebarez/cero@latest"
  "puredns|github.com/d3mondev/puredns/v2@latest"
  "dnsx|github.com/projectdiscovery/dnsx/cmd/dnsx@latest"
  "gf|github.com/tomnomnom/gf@latest"
  "unfurl|github.com/tomnomnom/unfurl@latest"
  "httpx|github.com/projectdiscovery/httpx/cmd/httpx@latest"
  "ffuf|github.com/ffuf/ffuf/v2@latest"
  "katana|github.com/projectdiscovery/katana/cmd/katana@latest"
  "gospider|github.com/jaeles-project/gospider@latest"
  "hakrawler|github.com/hakluke/hakrawler@latest"
  "getJS|github.com/003random/getJS/v2@latest"
  "jsluice|github.com/BishopFox/jsluice/cmd/jsluice@latest"
  "nuclei|github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest"
  "naabu|github.com/projectdiscovery/naabu/v2/cmd/naabu@latest"
)

WORDLISTS=(
  "https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/raft-large-directories.txt"
  "https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/raft-large-files.txt"
)

# ---------------- LOGGING ----------------
OK()   { printf "${GREEN}[✓] %s${RESET}\n" "$1"; }
INFO() { printf "${BLUE}[*] %s${RESET}\n" "$1"; }
WARN() { printf "${YELLOW}[!] %s${RESET}\n" "$1"; }
ERR()  { printf "${RED}[X] %s${RESET}\n" "$1" >&2; }

# ---------------- SPINNER & CLEANUP ----------------
CLEANUP() {
    if [[ -n "${SPINNER_PID:-}" ]]; then
        kill "$SPINNER_PID" 2>/dev/null || true
    fi
    echo -ne "\r\033[K"  # Clear spinner line
    exit 1
}
trap CLEANUP SIGINT

START_SPINNER() {
    processing="$1"
    SPIN_START=$(date +%s)
    BRAILLE=("⠋" "⠙" "⠹" "⠸" "⠼" "⠴" "⠦" "⠧" "⠇" "⠏")
    while true; do
        ELAPSED=$(( $(date +%s) - SPIN_START ))
        for char in "${BRAILLE[@]}"; do
            printf "\r${YELLOW}[${char}]${RESET} ${processing} ${CYAN}(${ELAPSED}s)${RESET}"
            sleep 0.07
        done
    done &
    SPINNER_PID=$!
}

STOP_SPINNER() {
    if [[ -n "${SPINNER_PID:-}" ]]; then
        kill "$SPINNER_PID" 2>/dev/null || true
        wait "$SPINNER_PID" 2>/dev/null || true
        echo -ne "\r\033[K"  # Clear spinner line
    fi
    local END=$(date +%s)
    ELAPSED=$(( END - SPIN_START ))
}

# ---------------- REQUIRE ROOT ----------------
REQUIRE_ROOT() {
  if (( EUID != 0 )); then
    echo -e "${RED}[X] Root privileges required.${RESET}"
    echo -e "${YELLOW}[*] Re-running with sudo...${RESET}\n"
    exec sudo -E bash "$0" "$@"
  fi
}

# ---------------- MAIN INSTALL ----------------
REQUIRE_ROOT "$@"

# ---------------- PREPARE DIRECTORIES ----------------
echo -e "${BOLD}${GREEN}=====================================================${RESET}"
INFO "Setting up directories and tools..."
mkdir -p "$TOOLS_DIR" "$BIN_DIR" "$WORDLISTS_DIR"
find "$INSTALL_DIR" -type f -exec chmod +x {} + || true

# ---------------- APT INSTALL WITH SPINNER ----------------
echo -e "${BOLD}${GREEN}=====================================================${RESET}"
INFO "Installing and Updating APT packages..."
START_SPINNER "Installing APT packages"
{
    apt-get update -y -qq && apt-get install -y -qq --no-install-recommends "${APT_PACKAGES[@]}"
} > /dev/null 2>&1
STOP_SPINNER
OK "APT packages installed in (${ELAPSED}s)"

# ---------------- GO INSTALL WITH SPINNER ----------------
echo -e "${BOLD}${GREEN}=====================================================${RESET}"v
if command -v go >/dev/null 2>&1; then
    export GOBIN="$BIN_DIR"
    export PATH="$GOBIN:$PATH"
    INFO "Installing Go tools..."
    for PAIR in "${GO_TOOLS[@]}"; do
        NAME="${PAIR%%|*}"
        PKG="${PAIR#*|}"
        START_SPINNER "Installing ${NAME}"
        START=$(date +%s)
        if go install -trimpath "$PKG" > /dev/null 2>&1; then
            STOP_SPINNER
            END=$(date +%s)
            OK "${NAME} installed in ($((END-START))s)"
        else
            STOP_SPINNER
            WARN "${NAME} installation failed"
        fi
    done
else
    WARN "Go not found – skipping Go tools"
fi

INSTALL_FINDOMAIN() {
  local URL="https://github.com/Findomain/Findomain/releases/latest/download/findomain-linux.zip"
  local TMP ZIP
  TMP=$(mktemp -d)
  ZIP="$TMP/findomain.zip"
  START_SPINNER "Installing findomain"
  START=$(date +%s)
  if curl -sL -o "$ZIP" "$URL" && unzip -q -o "$ZIP" -d "$BIN_DIR"; then
    chmod +x "$BIN_DIR/findomain" && STATUS="success"
  else
    STATUS="fail"
  fi

  STOP_SPINNER
  END=$(date +%s)
  TIME_TAKEN=$((END - START))

  if [[ "$STATUS" == "success" ]]; then
    OK "findomain installed in (${TIME_TAKEN}s)"
  else
    WARN "findomain installation failed (${TIME_TAKEN}s)"
  fi

  rm -rf "$TMP"
}
INSTALL_FINDOMAIN

# ---- SUBLIST3R ----
INSTALL_SUBLIST3R() {
  START_SPINNER "Installing sublist3r"
  START=$(date +%s)
  if [[ ! -d "$SUBLISTER_DIR" ]]; then
    git clone "https://github.com/aboul3la/Sublist3r.git" "$SUBLISTER_DIR" > /dev/null 2>&1 || true
    if pip3 install -q -r "$SUBLISTER_DIR/requirements.txt" --break-system-packages &>/dev/null; then
      STATUS="success"
    else
      STATUS="fail"
    fi
  else
    STATUS="fail"
  fi

  STOP_SPINNER
  END=$(date +%s)
  TIME_TAKEN=$((END - START))

  if [[ "$STATUS" == "success" ]]; then
    OK "sublist3r installed in (${TIME_TAKEN}s)"
  else
    WARN "sublist3r installation failed (${TIME_TAKEN}s)"
  fi
}
INSTALL_SUBLIST3R

INSTALL_MASSDNS() {
  START_SPINNER "Installing massdns"
  START=$(date +%s)
  git clone https://github.com/blechschmidt/massdns.git "/tmp/massdns" > /dev/null 2>&1 || true
  cd /tmp/massdns
  make > /dev/null || true
  sudo make install > /dev/null || true
  STOP_SPINNER
  END=$(date +%s)
  TIME_TAKEN=$((END - START))
  cp /tmp/massdns/bin/massdns "$BIN_DIR/"
  rm -rf /tmp/massdns
  if command -v massdns >/dev/null 2>&1; then
    STATUS="success"
  else
    STATUS="fail"
  fi
  if [[ "$STATUS" == "success" ]]; then
    OK "massdns installed in (${TIME_TAKEN}s)"
  else
    WARN "massdns installation failed (${TIME_TAKEN}s)"
  fi
}
INSTALL_MASSDNS

INSTALL_SUBDOMINATOR(){
  START_SPINNER "Installing subdominator"
  START=$(date +%s)
  pipx install subdominator --force > /dev/null 2>&1 || true
  mv "${HOME}/.local/share/pipx/venvs/subdominator/bin/subdominator" "$BIN_DIR/" > /dev/null 2>&1 || true
  STOP_SPINNER
  END=$(date +%s)
  TIME_TAKEN=$((END - START))
  chmod +x "$BIN_DIR/subdominator" || true
  if command -v subdominator >/dev/null 2>&1 ; then
    STATUS="success"
  else
    STATUS="fail"
  fi
  if [[ "$STATUS" == "success" ]]; then
    OK "subdominator installed in (${TIME_TAKEN}s)"
  else
    WARN "subdominator installation failed (${TIME_TAKEN}s)"
  fi
}
INSTALL_SUBDOMINATOR

# ---- CLONE GIT REPOS ----
echo -e "${BOLD}${GREEN}=====================================================${RESET}"
INFO "Cloning GF patterns..."
git clone "https://github.com/1ndianl33t/GF-Patterns.git" "$GF_DIR" > /dev/null 2>&1 || true
OK "GF patterns ready"

# ---- WORDLISTS ----
echo -e "${BOLD}${GREEN}=====================================================${RESET}"
INFO "Downloading Wordlists & Resolvers..."
for URL in "${WORDLISTS[@]}"; do
  FNAME=$(basename "$URL")
  START_SPINNER "Downloading $FNAME"
  if curl -sL -o "$WORDLISTS_DIR/$FNAME" "$URL"; then
    STOP_SPINNER
    OK "$FNAME Downloaded"
  else
    STOP_SPINNER
    WARN "$FNAME Download Failed"
  fi
done

echo -e "${BOLD}${GREEN}=====================================================${RESET}"
INFO "Downloading DNS Resolvers list..."
wget https://raw.githubusercontent.com/ghost11411/resolvers/refs/heads/main/stable_resolvers.txt -O "$WORDLISTS_DIR/resolvers.txt" -q
if [[ -s "$WORDLISTS_DIR/resolvers.txt" ]]; then
  OK "Resolvers list downloaded"
else
  WARN "Resolvers list download failed"
fi

# ---------------- PERMISSIONS & SYMLINKS ----------------
echo -e "${BOLD}${GREEN}=====================================================${RESET}"
INFO "Setting Permissions and Symlinks..."
find "$BIN_DIR" -type f -exec chmod 755 {} +
chmod +x "$INSTALL_DIR/scout" 2>/dev/null || true
ln -sf "$INSTALL_DIR/scout" /usr/local/bin/scout

# ---------------- VERIFY INSTALL ----------------
VERIFY_INSTALL() {
  INFO "Verifying installation integrity..."
  local ERRORS=0
  for PAIR in "${GO_TOOLS[@]}"; do
    NAME="${PAIR%%|*}"
    [[ -x "$BIN_DIR/$NAME" ]] || { WARN "Missing binary: $NAME"; ((ERRORS++)); }
  done
  [[ -x "$BIN_DIR/findomain" ]] || { WARN "Findomain missing"; ((ERRORS++)); }
  [[ -d "$SUBLISTER_DIR" ]] || { WARN "Sublist3r missing"; ((ERRORS++)); }
  [[ -x "$BIN_DIR/massdns" ]] || { WARN "Massdns missing"; ((ERRORS++)); }
  [[ -x "$BIN_DIR/subdominator" ]] || { WARN "Subdominator missing"; ((ERRORS++)); }
  for URL in "${WORDLISTS[@]}"; do
    FNAME=$(basename "$URL")
    [[ -s "$WORDLISTS_DIR/$FNAME" ]] || { WARN "Wordlist missing: $FNAME"; ((ERRORS++)); }
  done
  [[ -s "$WORDLISTS_DIR/resolvers.txt" ]] || { WARN "Resolvers list missing"; ((ERRORS++)); }
  [[ -L /usr/local/bin/scout && -x /usr/local/bin/scout ]] || { WARN "Symlink missing or not executable"; ((ERRORS++)); }
  (( ERRORS == 0 )) && OK "All verified successfully!" || WARN "$ERRORS issues detected."
}
VERIFY_INSTALL

# ---------------- FINAL ----------------
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))
echo -e "${BOLD}${GREEN}=====================================================${RESET}"
INFO "Installation Done in $(printf '%02d:%02d:%02d' $((ELAPSED/3600)) $(((ELAPSED/60)%60)) $((ELAPSED%60)))"
OK "Scout is ready!"
OK "Installed at: ${INSTALL_DIR}"
OK "Tools directory: ${TOOLS_DIR}"
OK "Wordlists directory: ${WORDLISTS_DIR}"
OK "Binaries directory: ${BIN_DIR}"
OK "Run 'scout --help' for usage information"
echo -e "${BOLD}${GREEN}=====================================================${RESET}"
echo -e "Run: ${BOLD}${CYAN}scout${RESET} or ${BOLD}${CYAN}scout --help${RESET}"
echo -e "GitHub: ${BOLD}${CYAN}${REPO_URL}${RESET}"
echo -e "${CYAN}${BOLD}Happy Hacking!${RESET}"
echo -e "${BOLD}${GREEN}=====================================================${RESET}"
exit 0